<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author"><title>C++ Test · 无辜者公墓</title><meta name="description" content="这篇文章记录一下我现在在 C++ 中使用的测试框架和测试流程(可比 Go, Rust 复杂多了…). 我用 GoogleTest 做单元测试, 用 CMake 构建和运行单元测试, 用 Clang 和 llvm-cov 做覆盖率的报告.
CMake 测试模块CMake 有一个测试模块, 叫做 CTe"><meta name="og:description" content="这篇文章记录一下我现在在 C++ 中使用的测试框架和测试流程(可比 Go, Rust 复杂多了…). 我用 GoogleTest 做单元测试, 用 CMake 构建和运行单元测试, 用 Clang 和 llvm-cov 做覆盖率的报告.
CMake 测试模块CMake 有一个测试模块, 叫做 CTe"><meta name="twitter:site" content="无辜者公墓"><meta name="twitter:title" content="C++ Test"><meta name="twitter:card" content="summary"><meta name="keywords" content="blog"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/bootstrap.min.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/style.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><meta name="generator" content="Hexo 6.3.0"><link rel="stylesheet" href="/css/prism.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head><body><div class="container" id="stage"><div class="row"><div class="col-sm-3 col-xs-12 side-container invisible" id="side-bar"><div class="vertical-text site-title"><h3 class="site-title-small" tabindex="-1"><a class="a-title" href="/"></a></h3><h1 class="site-title-large" tabindex="-1"><a class="a-title" href="/">无辜者公墓</a></h1><!--h6(onclick="triggerSiteNav()") Trigger--></div><br class="visible-lg visible-md visible-sm"><div class="site-title-links" id="site-nav"><ul><li><a href="/">Home</a></li><li><a href="/archives">Archive</a></li><li><a href="/categories">Categories</a></li><li><a href="/tags">Tags</a></li><li class="soc"><a href="https://github.com/Wang-Ji20" target="_blank" rel="noopener noreferrer" aria-label="Github"><i class="fa fa-github">&nbsp;</i></a><a href="http://Wang-Ji20.github.io/atom.xml" target="_blank" rel="noopener noreferrer" aria-label="RSS"><i class="fa fa-rss">&nbsp;</i></a></li></ul><div class="visible-lg visible-md visible-sm site-nav-footer"><br class="site-nav-footer-br"><footer><p>&copy;&nbsp;2023&nbsp;<a target="_blank" href="http://Wang-Ji20.github.io" rel="noopener noreferrer">Ji Wang</a></p><p>Theme&nbsp;<a target="_blank" href="https://github.com/SumiMakito/hexo-theme-typography" rel="noopener noreferrer">Typography</a>&nbsp;by&nbsp;<a target="_blank" href="https://www.keep.moe" rel="noopener noreferrer">Makito</a></p><p>Proudly published with&nbsp;<a target="_blank" href="https://hexo.io" rel="noopener noreferrer">Hexo</a></p></footer></div></div></div><div class="col-sm-9 col-xs-12 main-container invisible" id="main-container"><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post-container"><p class="post-title"><a>C++ Test</a></p><p class="post-meta"><span class="date meta-item">Posted at&nbsp;2023-08-29</span><span class="meta-item"><i class="fa fa-folder"></i><span>&nbsp;</span><a class="a-tag" href="/categories/CS/" title="CS">CS</a><span>&nbsp;</span></span><span class="meta-item"><i class="fa fa-tag"></i><span>&nbsp;</span><a class="a-tag" href="/tags/C/" title="C++">C++</a><span>&nbsp;</span><a class="a-tag" href="/tags/programming/" title="programming">programming</a><span>&nbsp;</span></span></p><p class="post-abstract"><p>这篇文章记录一下我现在在 <code>C++</code> 中使用的测试框架和测试流程(可比 <code>Go</code>, <code>Rust</code> 复杂多了…). 我用 <code>GoogleTest</code> 做单元测试, 用 <code>CMake</code> 构建和运行单元测试, 用 <code>Clang</code> 和 <code>llvm-cov</code> 做覆盖率的报告.</p>
<h2 id="CMake-测试模块"><a href="#CMake-测试模块" class="headerlink" title="CMake 测试模块"></a>CMake 测试模块</h2><p><code>CMake</code> 有一个测试模块, 叫做 <code>CTest</code>. 在根 <code>CMakeLists.txt</code> 用以下代码可以把这个模块加入进来.</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(CMAKE_PROJECT_NAME <span class="keyword">STREQUAL</span> PROJECT_NAME <span class="keyword">OR</span> MYPROJECT_BUILD_TESTING)</span><br><span class="line">    <span class="keyword">include</span>(CTest)</span><br><span class="line"><span class="keyword">endif</span>()</span><br></pre></td></tr></table></figure>

<p>有时候我们把当前代码作为其他代码库的依赖库. 这个情况下, 不需要测试. 所以我们用 <code>CMAKE_PROJECT_NAME</code> 和 <code>PROJECT_NAME</code> 来判断当前代码是否是一个独立的项目. 如果是, 才加入 <code>CTest</code>.</p>
<p>同样, 我们需要加入测试代码所在的文件夹.</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>( BUILD_TESTING</span><br><span class="line">    <span class="keyword">AND</span> (CMAKE_PROJECT_NAME <span class="keyword">STREQUAL</span> PROJECT_NAME</span><br><span class="line">         <span class="keyword">OR</span> MYPROJECT_BUILD_TESTING)</span><br><span class="line">)</span><br><span class="line">    <span class="keyword">add_subdirectory</span>(tests)</span><br><span class="line"><span class="keyword">endif</span>()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里需要开一个后门. 也许最后还是需要运行子项目的测试. 这个时候就用 <code>MYPROJECT_BUILD_TESTING</code> 来判断是否需要测试. 另外, 上面加入 <code>CTest</code> 的时候没有加入 <code>BUILD_TESTING</code>, 是因为 <code>CTest</code> 中已经包含了这个功能.</p>
<p>使用 <code>CTest</code> 可以让你在进入构建好的测试程序之后, 输入 <code>ctest</code> 命令就完成测试.</p>
<h2 id="加入-GoogleTest"><a href="#加入-GoogleTest" class="headerlink" title="加入 GoogleTest"></a>加入 GoogleTest</h2><p>首先需要加入 <code>GoogleTest</code> 这个库. 推荐使用两种方法引入它: <code>git submodule</code> 或者 <code>CMake FetchContent</code>.</p>
<p>用 <code>git submodule</code> :</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 用 ssh 因为 ssh 更稳定, 网络条件更好.</span></span><br><span class="line">git submodule add git@github.com:google/googletest.git ./third_party/googletest</span><br></pre></td></tr></table></figure>

<p>用 <code>FetchContent</code>:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span>(FetchContent)</span><br><span class="line">FetchContent_Declare(</span><br><span class="line">  googletest</span><br><span class="line">  URL https://github.com/google/googletest/archive/<span class="number">03597</span>a01ee50ed33e9dfd640b249b4be3799d395.zip</span><br><span class="line">)</span><br><span class="line"><span class="comment"># For Windows: Prevent overriding the parent project&#x27;s compiler/linker settings</span></span><br><span class="line"><span class="keyword">set</span>(gtest_force_shared_crt <span class="keyword">ON</span> CACHE BOOL <span class="string">&quot;&quot;</span> FORCE)</span><br><span class="line">FetchContent_MakeAvailable(googletest)</span><br></pre></td></tr></table></figure>

<p>另外就是, 不要忘了用 <code>target_include_directories</code> 或者 <code>include_directories()</code> (好像前者更推荐使用一些.) 把  <code>GoogleTest</code> 纳入头文件查找目录.</p>
<h2 id="编写单元测试"><a href="#编写单元测试" class="headerlink" title="编写单元测试"></a>编写单元测试</h2><p>这部分不是我的重点, 所以只是略加介绍. 一个最简单的单元测试长这样.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;gtest/gtest.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">TEST</span>(Suite1, Test1) &#123;</span><br><span class="line">    <span class="built_in">EXPECT_EQ</span>(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不需要写主函数. 没主函数, 链接上 <code>gtest_main</code> 就会白送一个. 我反正懒得写了.</p>
<h2 id="构建测试可执行文件"><a href="#构建测试可执行文件" class="headerlink" title="构建测试可执行文件"></a>构建测试可执行文件</h2><p>使用 <code>CMake</code> 构建可执行文件:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_executable</span>(<span class="variable">$&#123;测试的名字&#125;</span> EXCLUDE_FROM_ALL <span class="variable">$&#123;测试源代码&#125;</span>)</span><br><span class="line"><span class="keyword">target_link_libraries</span>(<span class="variable">$&#123;测试的名字&#125;</span>  gtest gtest_main)</span><br></pre></td></tr></table></figure>

<p>之后, 需要利用 <code>GoogleTest</code> 提供的指令, 把测试加入到 <code>CTest</code> 中. 这个指令是:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">gtest_discover_tests(<span class="keyword">target</span></span><br><span class="line">                     [EXTRA_ARGS arg1...] <span class="comment"># 运行测试的参数.</span></span><br><span class="line">                     [WORKING_DIRECTORY dir] <span class="comment"># 运行测试的工作路径.</span></span><br><span class="line">                     [TEST_PREFIX prefix]</span><br><span class="line">                     [TEST_SUFFIX suffix]</span><br><span class="line">                     [TEST_FILTER expr]</span><br><span class="line">                     [NO_PRETTY_TYPES] [NO_PRETTY_VALUES]</span><br><span class="line">                     [PROPERTIES name1 value1...]</span><br><span class="line">                     [TEST_LIST var]</span><br><span class="line">                     [DISCOVERY_TIMEOUT seconds]</span><br><span class="line">                     [XML_OUTPUT_DIR dir] <span class="comment"># 保存测试报告的地址.</span></span><br><span class="line">                     [DISCOVERY_MODE &lt;POST_BUILD|PRE_TEST&gt;]</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>然后在测试可执行程序的文件夹下面运行 <code>ctest</code> 就可以测试了.</p>
<p>我一般使用以下的指令自动寻找测试文件, 自动构建测试目标.</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">file</span>(GLOB_RECURSE TEST_SOURCES <span class="string">&quot;$&#123;PROJECT_SOURCE_DIR&#125;/test/*/*test.cc&quot;</span>)</span><br><span class="line"><span class="keyword">message</span>(STATUS <span class="string">&quot;Found $&#123;TEST_SOURCES&#125; test sources: $&#123;PROJECT_SOURCE_DIR&#125;/test/&quot;</span>)</span><br><span class="line"><span class="keyword">foreach</span> (test_source <span class="variable">$&#123;TEST_SOURCES&#125;</span>)</span><br><span class="line">    <span class="comment"># ......</span></span><br><span class="line">    <span class="comment"># 处理测试源代码. 用 gtest_discover_tests 加入到 CTest 中.</span></span><br><span class="line"><span class="keyword">endforeach</span> ()</span><br></pre></td></tr></table></figure>

<h2 id="覆盖率"><a href="#覆盖率" class="headerlink" title="覆盖率"></a>覆盖率</h2><p>我<a target="_blank" rel="noopener" href="https://github.com/Wang-Ji20/pigskinjelly/blob/main/build_support/cmake/LCOV.cmake">写了一个</a> Cmake Module 来做这件事. 用法是:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span>(CMAKE_MODULE_PATH <span class="variable">$&#123;CMAKE_MODULE_PATH&#125;</span> <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/build_support/cmake)</span><br><span class="line"><span class="keyword">set</span>(TEST_SOURCES_PATTERN ....) <span class="comment"># 测试源代码的匹配模式.</span></span><br><span class="line"><span class="keyword">include</span>(LCOV)</span><br><span class="line"><span class="keyword">include</span>(tests)</span><br></pre></td></tr></table></figure>

<p>它基本上需要和我的 <code>Googletest</code> 用 Cmake 文件一起使用, 我没试过其他的用法.</p>
<p>需要在电脑上有 <code>llvm-cov</code> <code>llvm-profdata</code>. 运行构建指令 <code>coverage-report</code> 之后, 会在 <code>build</code> 文件夹下面生成 <code>report.html</code> 文件. 用浏览器打开就可以看到覆盖率报告了. 具体原理就不详细介绍了. 效果大概是这样:</p>
<p><img src="/images/lcov-report.png" alt="覆盖率报告"></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p>[1] <a target="_blank" rel="noopener" href="https://cliutils.gitlab.io/modern-cmake">Modern CMake</a></p>
<p>[2] <a target="_blank" rel="noopener" href="https://google.github.io/googletest">GoogleTest User’s Guide</a></p>
<p>[3] <a target="_blank" rel="noopener" href="https://cmake.org/cmake/help/latest/module/GoogleTest.html">Cmake Document</a></p>
<p>[4] <a target="_blank" rel="noopener" href="https://clang.llvm.org/docs/SourceBasedCodeCoverage.html">Clang document: Source-based code cooverage</a></p>
<p>[5] <a target="_blank" rel="noopener" href="https://llvm.org/docs/CommandGuide/llvm-cov.html">llvm-cov document</a></p>
</p></div><div class="share"><span>Share</span>&nbsp;<span class="soc"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></span><span class="soc"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></span><span class="soc"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=http://Wang-Ji20.github.io/2023/08/29/C-Test/%20无辜者公墓%20C++ Test"></a></span></div><div class="pagination"><p class="clearfix"><span>&nbsp;</span><span class="next pagbuttons"><a role="navigation" href="/2023/08/28/clean-code/" title="Clean Code">Next post: Clean Code&nbsp;<i class="fa fa-angle-double-right"></i></a></span></p></div></div></div></div><div class="visible-xs site-bottom-footer"><footer><p>&copy;&nbsp;2023&nbsp;<a target="_blank" href="http://Wang-Ji20.github.io" rel="noopener noreferrer">Ji Wang</a></p><p>Theme&nbsp;<a target="_blank" href="https://github.com/SumiMakito/hexo-theme-typography" rel="noopener noreferrer">Typography</a>&nbsp;by&nbsp;<a target="_blank" href="https://www.keep.moe" rel="noopener noreferrer">Makito</a></p><p>Proudly published with&nbsp;<a target="_blank" href="https://hexo.io" rel="noopener noreferrer">Hexo</a></p></footer></div></div></div></div><script src="/js/jquery-3.1.0.min.js"></script><script src="/js/bootstrap.min.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/google-analytics.js"></script><script src="/js/typography.js"></script></body></html>