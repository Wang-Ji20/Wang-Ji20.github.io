<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="无辜者公墓" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body>
    <h1>
    C++ Test
</h1>

<p>
    <p>这篇文章记录一下我现在在 <code>C++</code> 中使用的测试框架和测试流程(可比 <code>Go</code>, <code>Rust</code> 复杂多了…). 我用 <code>GoogleTest</code> 做单元测试, 用 <code>CMake</code> 构建和运行单元测试, 用 <code>Clang</code> 和 <code>llvm-cov</code> 做覆盖率的报告.</p>
<h2 id="CMake-测试模块"><a href="#CMake-测试模块" class="headerlink" title="CMake 测试模块"></a>CMake 测试模块</h2><p><code>CMake</code> 有一个测试模块, 叫做 <code>CTest</code>. 在根 <code>CMakeLists.txt</code> 用以下代码可以把这个模块加入进来.</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre class="line-numbers language-hljs cmake"><span class="hljs-keyword">if</span>(CMAKE_PROJECT_NAME <span class="hljs-keyword">STREQUAL</span> PROJECT_NAME <span class="hljs-keyword">OR</span> MYPROJECT_BUILD_TESTING)<br>    <span class="hljs-keyword">include</span>(CTest)<br><span class="hljs-keyword"><code class="language-hljs cmake"><span class="hljs-keyword">if</span>(CMAKE_PROJECT_NAME <span class="hljs-keyword">STREQUAL</span> PROJECT_NAME <span class="hljs-keyword">OR</span> MYPROJECT_BUILD_TESTING)<br>    <span class="hljs-keyword">include</span>(CTest)<br><span class="hljs-keyword">endif</span>()<br><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></td></tr></table></figure>

<p>有时候我们把当前代码作为其他代码库的依赖库. 这个情况下, 不需要测试. 所以我们用 <code>CMAKE_PROJECT_NAME</code> 和 <code>PROJECT_NAME</code> 来判断当前代码是否是一个独立的项目. 如果是, 才加入 <code>CTest</code>.</p>
<p>同样, 我们需要加入测试代码所在的文件夹.</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre class="line-numbers language-hljs cmake"><span class="hljs-keyword">if</span>( BUILD_TESTING<br>    <span class="hljs-keyword">AND</span> (CMAKE_PROJECT_NAME <span class="hljs-keyword">STREQUAL</span> PROJECT_NAME<br>         <span class="hljs-keyword">OR</span> MYPROJECT_BUILD_TESTING)<br>)<br>    <span class="hljs-keyword">add_subdirectory</span>(tests)<br><span class="hljs-keyword"><code class="language-hljs cmake"><span class="hljs-keyword">if</span>( BUILD_TESTING<br>    <span class="hljs-keyword">AND</span> (CMAKE_PROJECT_NAME <span class="hljs-keyword">STREQUAL</span> PROJECT_NAME<br>         <span class="hljs-keyword">OR</span> MYPROJECT_BUILD_TESTING)<br>)<br>    <span class="hljs-keyword">add_subdirectory</span>(tests)<br><span class="hljs-keyword">endif</span>()<br><br><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></td></tr></table></figure>

<p>这里需要开一个后门. 也许最后还是需要运行子项目的测试. 这个时候就用 <code>MYPROJECT_BUILD_TESTING</code> 来判断是否需要测试. 另外, 上面加入 <code>CTest</code> 的时候没有加入 <code>BUILD_TESTING</code>, 是因为 <code>CTest</code> 中已经包含了这个功能.</p>
<p>使用 <code>CTest</code> 可以让你在进入构建好的测试程序之后, 输入 <code>ctest</code> 命令就完成测试.</p>
<h2 id="加入-GoogleTest"><a href="#加入-GoogleTest" class="headerlink" title="加入 GoogleTest"></a>加入 GoogleTest</h2><p>首先需要加入 <code>GoogleTest</code> 这个库. 推荐使用两种方法引入它: <code>git submodule</code> 或者 <code>CMake FetchContent</code>.</p>
<p>用 <code>git submodule</code> :</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class="line-numbers language-hljs bash"><span class="hljs-comment"><code class="language-hljs bash"><span class="hljs-comment"># 用 ssh 因为 ssh 更稳定, 网络条件更好.</span><br>git submodule add git@github.com:google/googletest.git ./third_party/googletest<br><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></td></tr></table></figure>

<p>用 <code>FetchContent</code>:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre class="line-numbers language-hljs cmake"><span class="hljs-keyword">include</span>(FetchContent)<br>FetchContent_Declare(<br>  googletest<br>  URL https://github.com/google/googletest/archive/<span class="hljs-number">03597</span>a01ee50ed33e9dfd640b249b4be3799d395.zip<br>)<br><span class="hljs-comment"># For Windows: Prevent overriding the parent project&#x27;s compiler/linker settings</span><br><span class="hljs-keyword">set</span>(gtest_force_shared_crt <span class="hljs-keyword">ON</span> CACHE BOOL <span class="hljs-string"><code class="language-hljs cmake"><span class="hljs-keyword">include</span>(FetchContent)<br>FetchContent_Declare(<br>  googletest<br>  URL https://github.com/google/googletest/archive/<span class="hljs-number">03597</span>a01ee50ed33e9dfd640b249b4be3799d395.zip<br>)<br><span class="hljs-comment"># For Windows: Prevent overriding the parent project&#x27;s compiler/linker settings</span><br><span class="hljs-keyword">set</span>(gtest_force_shared_crt <span class="hljs-keyword">ON</span> CACHE BOOL <span class="hljs-string">""</span> FORCE)<br>FetchContent_MakeAvailable(googletest)<br><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></td></tr></table></figure>

<p>另外就是, 不要忘了用 <code>target_include_directories</code> 或者 <code>include_directories()</code> (好像前者更推荐使用一些.) 把  <code>GoogleTest</code> 纳入头文件查找目录.</p>
<h2 id="编写单元测试"><a href="#编写单元测试" class="headerlink" title="编写单元测试"></a>编写单元测试</h2><p>这部分不是我的重点, 所以只是略加介绍. 一个最简单的单元测试长这样.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre class="line-numbers language-hljs C++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;gtest/gtest.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><br><span class="hljs-built_in">TEST</span>(Suite1, Test1) &#123;<br>    <span class="hljs-built_in">EXPECT_EQ</span>(<span class="hljs-number">1</span>, <span class="hljs-number"><code class="language-hljs C++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;gtest/gtest.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><br><span class="hljs-built_in">TEST</span>(Suite1, Test1) &#123;<br>    <span class="hljs-built_in">EXPECT_EQ</span>(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<br>&#125;<br><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></td></tr></table></figure>

<p>不需要写主函数. 没主函数, 链接上 <code>gtest_main</code> 就会白送一个. 我反正懒得写了.</p>
<h2 id="构建测试可执行文件"><a href="#构建测试可执行文件" class="headerlink" title="构建测试可执行文件"></a>构建测试可执行文件</h2><p>使用 <code>CMake</code> 构建可执行文件:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class="line-numbers language-hljs cmake"><span class="hljs-keyword">add_executable</span>(<span class="hljs-variable">$&#123;测试的名字&#125;</span> EXCLUDE_FROM_ALL <span class="hljs-variable">$&#123;测试源代码&#125;</span>)<br><span class="hljs-keyword">target_link_libraries</span>(<span class="hljs-variable"><code class="language-hljs cmake"><span class="hljs-keyword">add_executable</span>(<span class="hljs-variable">$&#123;测试的名字&#125;</span> EXCLUDE_FROM_ALL <span class="hljs-variable">$&#123;测试源代码&#125;</span>)<br><span class="hljs-keyword">target_link_libraries</span>(<span class="hljs-variable">$&#123;测试的名字&#125;</span>  gtest gtest_main)<br><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></td></tr></table></figure>

<p>之后, 需要利用 <code>GoogleTest</code> 提供的指令, 把测试加入到 <code>CTest</code> 中. 这个指令是:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre class="line-numbers language-hljs cmake">gtest_discover_tests(<span class="hljs-keyword">target</span><br>                     [EXTRA_ARGS arg1...] <span class="hljs-comment"># 运行测试的参数.</span><br>                     [WORKING_DIRECTORY dir] <span class="hljs-comment"># 运行测试的工作路径.</span><br>                     [TEST_PREFIX prefix]<br>                     [TEST_SUFFIX suffix]<br>                     [TEST_FILTER expr]<br>                     [NO_PRETTY_TYPES] [NO_PRETTY_VALUES]<br>                     [PROPERTIES name1 value1...]<br>                     [TEST_LIST var]<br>                     [DISCOVERY_TIMEOUT seconds]<br>                     [XML_OUTPUT_DIR dir] <span class="hljs-comment"><code class="language-hljs cmake">gtest_discover_tests(<span class="hljs-keyword">target</span><br>                     [EXTRA_ARGS arg1...] <span class="hljs-comment"># 运行测试的参数.</span><br>                     [WORKING_DIRECTORY dir] <span class="hljs-comment"># 运行测试的工作路径.</span><br>                     [TEST_PREFIX prefix]<br>                     [TEST_SUFFIX suffix]<br>                     [TEST_FILTER expr]<br>                     [NO_PRETTY_TYPES] [NO_PRETTY_VALUES]<br>                     [PROPERTIES name1 value1...]<br>                     [TEST_LIST var]<br>                     [DISCOVERY_TIMEOUT seconds]<br>                     [XML_OUTPUT_DIR dir] <span class="hljs-comment"># 保存测试报告的地址.</span><br>                     [DISCOVERY_MODE <POST_BUILD|PRE_TEST>]<br>)<br><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></td></tr></table></figure>

<p>然后在测试可执行程序的文件夹下面运行 <code>ctest</code> 就可以测试了.</p>
<p>我一般使用以下的指令自动寻找测试文件, 自动构建测试目标.</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre class="line-numbers language-hljs cmake"><span class="hljs-keyword">file</span>(GLOB_RECURSE TEST_SOURCES <span class="hljs-string">&quot;$&#123;PROJECT_SOURCE_DIR&#125;/test/*/*test.cc&quot;</span>)<br><span class="hljs-keyword">message</span>(STATUS <span class="hljs-string">&quot;Found $&#123;TEST_SOURCES&#125; test sources: $&#123;PROJECT_SOURCE_DIR&#125;/test/&quot;</span>)<br><span class="hljs-keyword">foreach</span> (test_source <span class="hljs-variable">$&#123;TEST_SOURCES&#125;</span>)<br>    <span class="hljs-comment"># ......</span><br>    <span class="hljs-comment"># 处理测试源代码. 用 gtest_discover_tests 加入到 CTest 中.</span><br><span class="hljs-keyword"><code class="language-hljs cmake"><span class="hljs-keyword">file</span>(GLOB_RECURSE TEST_SOURCES <span class="hljs-string">&quot;$&#123;PROJECT_SOURCE_DIR&#125;/test/*/*test.cc&quot;</span>)<br><span class="hljs-keyword">message</span>(STATUS <span class="hljs-string">&quot;Found $&#123;TEST_SOURCES&#125; test sources: $&#123;PROJECT_SOURCE_DIR&#125;/test/&quot;</span>)<br><span class="hljs-keyword">foreach</span> (test_source <span class="hljs-variable">$&#123;TEST_SOURCES&#125;</span>)<br>    <span class="hljs-comment"># ......</span><br>    <span class="hljs-comment"># 处理测试源代码. 用 gtest_discover_tests 加入到 CTest 中.</span><br><span class="hljs-keyword">endforeach</span> ()<br><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></td></tr></table></figure>

<h2 id="覆盖率"><a href="#覆盖率" class="headerlink" title="覆盖率"></a>覆盖率</h2><p>我<a target="_blank" rel="noopener" href="https://github.com/Wang-Ji20/pigskinjelly/blob/main/build_support/cmake/LCOV.cmake">写了一个</a> Cmake Module 来做这件事. 用法是:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre class="line-numbers language-hljs cmake"><span class="hljs-keyword">set</span>(CMAKE_MODULE_PATH <span class="hljs-variable">$&#123;CMAKE_MODULE_PATH&#125;</span> <span class="hljs-variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/build_support/cmake)<br><span class="hljs-keyword">set</span>(TEST_SOURCES_PATTERN ....) <span class="hljs-comment"># 测试源代码的匹配模式.</span><br><span class="hljs-keyword">include</span>(LCOV)<br><span class="hljs-keyword"><code class="language-hljs cmake"><span class="hljs-keyword">set</span>(CMAKE_MODULE_PATH <span class="hljs-variable">$&#123;CMAKE_MODULE_PATH&#125;</span> <span class="hljs-variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/build_support/cmake)<br><span class="hljs-keyword">set</span>(TEST_SOURCES_PATTERN ....) <span class="hljs-comment"># 测试源代码的匹配模式.</span><br><span class="hljs-keyword">include</span>(LCOV)<br><span class="hljs-keyword">include</span>(tests)<br><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></td></tr></table></figure>

<p>它基本上需要和我的 <code>Googletest</code> 用 Cmake 文件一起使用, 我没试过其他的用法.</p>
<p>需要在电脑上有 <code>llvm-cov</code> <code>llvm-profdata</code>. 运行构建指令 <code>coverage-report</code> 之后, 会在 <code>build</code> 文件夹下面生成 <code>report.html</code> 文件. 用浏览器打开就可以看到覆盖率报告了. 具体原理就不详细介绍了. 效果大概是这样:</p>
<p><img src="/images/lcov-report.png" alt="覆盖率报告"></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p>[1] <a target="_blank" rel="noopener" href="https://cliutils.gitlab.io/modern-cmake">Modern CMake</a></p>
<p>[2] <a target="_blank" rel="noopener" href="https://google.github.io/googletest">GoogleTest User’s Guide</a></p>
<p>[3] <a target="_blank" rel="noopener" href="https://cmake.org/cmake/help/latest/module/GoogleTest.html">Cmake Document</a></p>
<p>[4] <a target="_blank" rel="noopener" href="https://clang.llvm.org/docs/SourceBasedCodeCoverage.html">Clang document: Source-based code cooverage</a></p>
<p>[5] <a target="_blank" rel="noopener" href="https://llvm.org/docs/CommandGuide/llvm-cov.html">llvm-cov document</a></p>

</p>

</body>

</html>
